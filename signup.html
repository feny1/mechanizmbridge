<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/v4-shims.min.css">
    <title>Mechanism Bridge Co.</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="assets/styles.css">
    <!-- iconfav -->
    <link rel="icon" href="/imgs/mechanismbridge.svg" type="image/png">
</head>

<body>
    <header>
        <div onclick="window.location.href='./'" class="logo">
            <img src="imgs/mechanismbridge.svg" alt="">

        </div>
        <nav>
            <ul class="nav-links">
                <li><a href="./#why">ููุงุฐุง ูููุงูุฒู ุจุฑูุฏุฌุ</a></li>
                <li><a href="./#how">ููููุฉ ุงูุชุณุฌูู</a></li>
                <!-- <li><a href="./#much">ุฃุฑูุงููุง</a></li> -->
                <li><a href="./#share">ุดุงุฑููุง</a></li>
                <li><a href="./#about">ุนู ูููุงูุฒู ุจุฑูุฏุฌ</a></li>
            </ul>
        </nav>
        <div class="actions">
            <div class="signup" onclick="window.location.href='./signup.html'">ุชุณุฌูู</div>
            <div class="login" onclick="window.location.href='./login.html'">ุชุณุฌูู ุฏุฎูู</div>
        </div>
        <div class="lang">
            <div class="lang-ar">ุนุฑุจู</div>
            <div class="lang-en">English</div>
            <i class="icon fa fa-globe mx-1"></i>
        </div>
    </header>
    <div class="hero signup">
        <img class="bg" src="imgs/backgroundhero.png" alt="">
        <form id="signin-form" action="">
            <h1>ุงูุถู ุฅูู ูููุงูุฒู ุจุฑูุฏุฌ</h1>
            <h2>ููุตุฉ ูุชูุงููุฉ ุชุฑุจุท ุงูุดุฑูุงุช ุจุฑูุงุฏ ุงูุฃุนูุงู ูุงูููุฑุฏูู ูุชูุฏูู ุญููู ุชุดุบูููุฉ ูุชูููููุฉ ูุจุชูุฑุฉ ุชุนุฒุฒ ุงูููู ูุชุฎูู
                ุดุฑุงูุงุช ูุงุฌุญุฉ</h2>
            <div class="input-group">
                <input id="username" type="text" placeholder="ุงูุงุณู ุงููุฑูู" required>
                <input id="phone" type="text" placeholder="ุฑูู ุงูุฌูุงู +966" required>
                <input id="commericalid" type="text" placeholder="ุฑูู ุงูุณุฌู ุงูุชุฌุงุฑู" required>
                <input id="city" type="text" placeholder="ุงููุฏููุฉ" required>
                <div class="password-wrapper">
                    <input onchange="passwordValidation()" id="password" type="password" placeholder="ูููุฉ ุงููุฑูุฑ"
                        required>
                    <i onclick="togglePassword('password', this)" class="fas fa-eye"></i>
                </div>

                <div class="password-wrapper">
                    <input onchange="passwordValidation()" id="repassword" type="password"
                        placeholder="ุฅุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ" required>
                    <i onclick="togglePassword('repassword', this)" class="fas fa-eye"></i>
                </div>

                <h4 id="warning"></h4>
            </div>

            <div class="actions">
                <div class="signup" onclick="handleSignup()">ุชุณุฌูู</div>
                <div class="login" onclick="window.location.href='./'">ุงูุนูุฏุฉ</div>
            </div>
        </form>
        <form class="otp hide">
            <h4>ุณุชุตูู ุฑุณุงูุฉ ูุตูุฉ ุจุฑูุฒ ุงูุชุญูู ุนูู ุฑูู ุงูุฌูุงู ุงูุฐู ุฃุฏุฎูุชู</h4>
            <div class="otp-inputs">
                <input type="text" maxlength="1" class="otp-input" required>
                <input type="text" maxlength="1" class="otp-input" required>
                <input type="text" maxlength="1" class="otp-input" required>
                <input type="text" maxlength="1" class="otp-input" required>
                <input type="text" maxlength="1" class="otp-input" required>
                <input type="text" maxlength="1" class="otp-input" required>
            </div>
            <button type="button" class="resend-otp">ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุฑูุฒ</button>
            <div class="actions">
                <div class="signup" onclick="signup(otpCheck())">ุชุฃููุฏ</div>
                <div class="login" onclick="window.location.href='./'">ุงูุนูุฏุฉ</div>
            </div>

        </form>
    </div>
    <footer class="footer">
        <div class="footer-content">
            <p>ุฌููุน ุงูุญููู ูุญููุธุฉ &copy; 2025 ูููุงูุฒู ุจุฑูุฏุฌ</p>
            <ul class="social-links">
                <li><a href="#"><i class="fab fa-facebook-f"></i></a></li>
                <li><a href="#"><i class="fab fa-twitter"></i></a></li>
                <li><a href="#"><i class="fab fa-instagram"></i></a></li>
                <li><a href="#"><i class="fab fa-linkedin-in"></i></a></li>
                <!-- whatsapp -->
                <li><a href="https://api.whatsapp.com/send?phone=966542399527" target="_blank"><i
                            class="fab fa-whatsapp"></i></a></li>
            </ul>
        </div>
    </footer>
    <script src="assets/script.js"></script>
    <script src="assets/otp.js?asd"></script>
    <script>
        var global_otp = '';
        async function handleSignup() {




            const inputs = document.querySelectorAll('.input-group input');
            const phoneInput = inputs[1].value;

            // check if phone are not used before using the API
            const isPhoneUsed = await checkPhoneNumber(phoneInput);
            if (isPhoneUsed) {
                alert('๐ฑ ุฑูู ุงูุฌูุงู ูุฐุง ูุณุชุฎุฏู ุจุงููุนู. ูุฑุฌู ุงุณุชุฎุฏุงู ุฑูู ุขุฎุฑ.');
                return;
            }
            if (!phoneInput.startsWith('966')) {
                alert('๐ฑ ุฃุฏุฎู ุฑูู ุงูุฌูุงู ุจุตูุบุฉ 966xxxxxxxxx');
                return;
            }
            if (!passwordValidation()) {
                alert('โ๏ธ ูุฑุฌู ุงูุชุฃูุฏ ูู ุตุญุฉ ูููุฉ ุงููุฑูุฑ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ.');
                return;
            }

            const otp = await sendWhatsAppOTP("+" + phoneInput);
            if (otp) {
                global_otp = otp; // Store the OTP for later verification
                // Hide the signup form and show the OTP form
                document.getElementById('signin-form').classList.add('hide');
                document.querySelector('.otp').classList.remove('hide');

                // make the resend button enabled after 5 minutes
                let resendButton = document.querySelector('.resend-otp');
                resendButton.disabled = true;
                resendButton.textContent = 'ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุฑูุฒ (5 ุฏูุงุฆู)';
                let countdown = 300; // 5 minutes in seconds
                const interval = setInterval(() => {
                    countdown--;
                    if (countdown <= 0) {
                        clearInterval(interval);
                        resendButton.disabled = false;
                        resendButton.textContent = 'ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุฑูุฒ';
                    } else {
                        resendButton.textContent = `ุฅุนุงุฏุฉ ุฅุฑุณุงู ุงูุฑูุฒ (${Math.floor(countdown / 60)}:${countdown % 60
                            .toString().padStart(2, '0')})`;
                    }
                }, 1000);

                // Add event listener to the resend button
                document.querySelector('.resend-otp').addEventListener('click', async () => {
                    const newOtp = await sendWhatsAppOTP("+" + phoneInput);
                    global_otp = newOtp; // Update the global OTP
                    if (newOtp) {
                        alert('๐ฑ ุชู ุฅุนุงุฏุฉ ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู ุจูุฌุงุญ.');
                    } else {
                        alert('โ๏ธ ูุดู ูู ุฅุนุงุฏุฉ ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.');
                    }
                });
            } else {
                alert('โ๏ธ ูุดู ูู ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.');
            }
        }
        // check password match, check password validation
        function passwordValidation() {
            const passwordEl = document.getElementById('password');
            const repassword = document.getElementById('repassword').value;
            const warningEl = document.getElementById('warning');
            const password = passwordEl.value;

            if (password.length < 8) {
                passwordEl.setCustomValidity('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู ุนูู ุงูุฃูู 8 ุฃุญุฑู');
                warningEl.textContent = 'ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชููู ุนูู ุงูุฃูู 8 ุฃุญุฑู';
                return false;
            } else if (!/[A-Z]/.test(password)) {
                passwordEl.setCustomValidity('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุญุฑู ูุจูุฑ ูุงุญุฏ ุนูู ุงูุฃูู');
                warningEl.textContent = 'ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุญุฑู ูุจูุฑ ูุงุญุฏ ุนูู ุงูุฃูู';
                return false;
            } else if (!/[a-z]/.test(password)) {
                passwordEl.setCustomValidity('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุญุฑู ุตุบูุฑ ูุงุญุฏ ุนูู ุงูุฃูู');
                warningEl.textContent = 'ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุญุฑู ุตุบูุฑ ูุงุญุฏ ุนูู ุงูุฃูู';
                return false;
            } else if (!/[0-9]/.test(password)) {
                passwordEl.setCustomValidity('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุฑูู ูุงุญุฏ ุนูู ุงูุฃูู');
                warningEl.textContent = 'ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุฑูู ูุงุญุฏ ุนูู ุงูุฃูู';
                return false;
            } else if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                passwordEl.setCustomValidity('ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุฑูุฒ ุฎุงุต ูุงุญุฏ ุนูู ุงูุฃูู');
                warningEl.textContent = 'ูููุฉ ุงููุฑูุฑ ูุฌุจ ุฃู ุชุญุชูู ุนูู ุฑูุฒ ุฎุงุต ูุงุญุฏ ุนูู ุงูุฃูู';
                return false;
            } else if (password.length > 20) {
                passwordEl.setCustomValidity('ูููุฉ ุงููุฑูุฑ ูุง ูููู ุฃู ุชุชุฌุงูุฒ 20 ุญุฑููุง');
                warningEl.textContent = 'ูููุฉ ุงููุฑูุฑ ูุง ูููู ุฃู ุชุชุฌุงูุฒ 20 ุญุฑููุง';
                return false;
            } else if (password !== repassword) {
                passwordEl.setCustomValidity('ูููุฉ ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุฉ');
                warningEl.textContent = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุฉ';
                return false;
            } else {
                passwordEl.setCustomValidity('');
                warningEl.textContent = '';
                return true; // Password is valid
            }
        }

        function checkPhoneNumber(phone) {
            fetch('actions/check_phone.php', {
                method: 'POST',
                body: new URLSearchParams({ phone })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'exists') {
                        return true; // Phone number is already used
                    } else {
                        return false; // Phone number is not used
                    }
                })
                .catch(err => {
                    console.error(err);
                });
        } 

        function signup(otpChecked) {
            if(!otpChecked){
                alert("ุงูุฑูุฒ ุงููุฏุฎู ุฎุงุทุฆ");
                return;
            }
            const formData = new FormData();

            formData.append('username', document.getElementById('username').value);
            formData.append('phone', document.getElementById('phone').value);
            formData.append('commericalid', document.getElementById('commericalid').value);
            formData.append('city', document.getElementById('city').value);
            formData.append('password', document.getElementById('password').value);
            formData.append('repassword', document.getElementById('repassword').value);

            fetch('actions/signin.php', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        window.location.href = './login.html';
                    } else {
                        alert(data.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจุงูุฎุงุฏู');
                });
        }

    </script>
</body>

</html>